---
title: android插件化原理
date: 2020-04-30 22:02:31
tags: skill
categories: Android
img:
---

### 前言

如今app的包体积是越来越大了，里面充斥着各种功能，用户使用起来不禁会怨声载道，我只想使用XX功能，你们硬塞给我这么多功能，浪费我手机内存，差评。作为开发者，面对这些用户的反馈，不禁会想怎样能按需加载用户所需要的内容呢？用户想使用什么功能，就自己去下载安装，不想用就卸载，如果有这样的插件化功能，app的灵活度就会大大提高，用户也不会因为一次下载过大的apk而给app刷差评了。

<!--more-->

### 实现插件化的目的

通过前面一个案例的介绍，我们可以总结出，实现插件化的目的有二：

1. 减小包体积
2. 拓展app的功能性

### 插件化的实现难点

那么该如何实现这个需求呢？我们可以大体想到整体流程

首先，在开发过程中我们需要将相对独立的功能分离出来  
然后，用户在需求插件时将插件下载到手机内存之中  
最后，加载下载的apk文件

前两者还好说，最后一步该如何做？要做到最后一步首先我们应该了解一下四大组件的启动流程，以及android资源的加载流程，毕竟apk也就是个压缩文件，解压后得到dex文件和资源文件，要知道系统是通过DexClassLoader加载dex文件，最后再通过AcitvityManager去启动四大组件，Activity通过manifest配置文件去读取注册的四大组件，之后通过反射启动它们，但是插件中的四大组件是没有在manifest文件中注册过的，如果不注册也能启动插件中的这些类是不是就达到这个目的了？这也就是插件化的第一个难点绕过系统检测启动插件中的四大组件。资源文件是通过AssertManager加载资源文件，插件中资源文件可能与宿主中的资源id产生冲突，如何解决这些冲突则是我们要处理的第二个问题。明确了这两个问题，我们就想办法去逐个解决它们是不是就能达到插件化的目的了呢？找到问题点对症下药是我们处理问题的一贯伎俩。

### 插件化的实现思路

问题点

1. 如何支持四大组件
2. 资源加载与资源冲突的解决

要解决第一个问题，首先要知道Android中四大组件的启动流程，原理不清楚，那切入点在什么地方自然就不知道了，如果对四大组件的启动流程不太清楚的同学，建议先看看源码，或参考一下

- {% post_link Android四大组件启动流程 Android四大组件启动流程 %}



### 插件化的成熟方案

### 结语
